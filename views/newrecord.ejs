<%- include('initials/header.ejs', { title: 'Add New Record' }) %>
<link rel="stylesheet" href="/styles/newrecord.css">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-md">
                    <div class="card-body">
                        <h3 class="card-title mb-4 text-primary"><i class="fas fa-file-medical me-2"></i> Add New Medical Record</h3>
                        <p class="text-muted">Logged in as: <strong><%= doctor_name %> (Admin)</strong></p>

                        <form action="/newrecord" method="POST" class="row g-4">
                            
                            <div class="col-md-6">
                                <label for="patient_id" class="form-label">Patient Name*</label>
                                <select id="patient_id" name="patient_id" class="form-select form-control" required>
    <option value="" disabled <%= !preselectedPatientId ? "selected" : "" %>>Select Patient</option>
    <% patients.forEach(patient => { %>
        <option 
            value="<%= patient.id %>" 
            <%= (preselectedPatientId == patient.id) ? "selected" : "" %>>
            <%= patient.username %> (<%= patient.email %>)
        </option>
    <% }); %>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="appointment_id" class="form-label">Link to Appointment (Optional)</label>
                                <select id="appointment_id" name="appointment_id" class="form-select form-control">
                                <option value="" selected>--- Select Associated Appointment ---</option>
                                <% if (appointments && appointments.length > 0) { %>
                                <% appointments.forEach(appt => { %>
                                    <option value="<%= appt.id %>">
                                        [<%= appt.id %>.] <%= appt.patient_name %> with Dr. <%= appt.doctor_name %>
                                    </option>
                                <% }); %>
                                <% } %>
                                </select>
                                <div class="form-text">Links this record to the source appointment for continuity.</div>
                            </div>

                            <div class="col-md-6">
                                <label for="record_date" class="form-label">Record Date*</label>
                                <input id="record_date" name="record_date" type="date" class="form-control" required value="<%= new Date().toISOString().split('T')[0] %>">
                            </div>
                            
                            <div class="col-12">
                                <label for="diagnosis" class="form-label">Diagnosis*</label>
                                <textarea id="diagnosis" name="diagnosis" class="form-control" rows="2" required placeholder="Enter primary diagnosis"></textarea>
                            </div>

                            <div class="col-12">
                                <label for="treatment_plan" class="form-label">Treatment Plan:</label>
                                <textarea id="treatment_plan" name="treatment_plan" class="form-control" rows="3" placeholder="Outline the treatment and medications"></textarea>
                            </div>

                            <div class="col-12">
                                <label for="doctor_notes" class="form-label">Doctor Notes:</label>
                                <textarea id="doctor_notes" name="doctor_notes" class="form-control" rows="3" placeholder="Detailed consultation notes"></textarea>
                            </div>

                            <div class="col-md-6">
                                <label for="blood_pressure" class="form-label">Blood Pressure (e.g., 120/80):</label>
                                <input id="blood_pressure" name="blood_pressure" type="text" class="form-control" placeholder="BP">
                            </div>

                            <div class="col-md-6">
                                <label for="allergies" class="form-label">Allergies (Comma Separated):</label>
                                <input id="allergies" name="allergies" type="text" class="form-control" placeholder="e.g., Penicillin, Peanuts">
                            </div>

                            <div class="col-12 text-end pt-3">
                                <button type="submit" class="btn btn-primary btn-lg me-2">
                                    <i class="fas fa-save me-2"></i> Save Record
                                </button>
                                <a href="/records" class="btn btn-light btn-lg">
                                    <i class="fas fa-times me-2"></i> Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
<%- include('initials/footer.ejs') %>
<%- include('initials/header.ejs', { title: 'Patient Hub' }) %>
<link rel="stylesheet" href="/styles/admin_patient_view.css">
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4 animate-load-slide-up" style="animation-delay: 0.1s;">
        <div>
            <h2 class="mb-1 text-primary"><%= patient.username %></h2>
            <p class="lead text-muted">Patient Management Hub</p>
        </div>
        <a href="/admin/staff" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Back to Staff List</a>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4 animate-on-scroll animate-slide-up" style="transition-delay: 0.1s;">
                <div class="card-header bg-primary text-white fw-bold"><i class="fas fa-user-circle me-2"></i> Patient Information</div>
                <div class="card-body">
                    <p><strong>Email:</strong> <%= patient.email %></p>
                    <p><strong>Phone:</strong> <%= patient.phone || 'N/A' %></p>
                    <hr>
                    <p><strong>Insurance:</strong> <%= patient.insurance_provider || 'N/A' %></p>
                    <p><strong>Policy ID:</strong> <%= patient.policy_number || 'N/A' %></p>
                </div>
            </div>

            <div class="card shadow-sm mb-4 animate-on-scroll animate-slide-up" style="transition-delay: 0.2s;">
                <div class="card-header bg-light text-dark fw-bold"><i class="fas fa-dollar-sign me-2"></i> Financials</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Wallet Balance:</span>
                        <span class="fw-bold text-success">$<%= patient.wallet_balance %></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Outstanding:</span>
                        <span class="fw-bold text-danger">$<%= outstandingBalance %></span>
                    </li>
                </ul>
            </div>
            
            <div class="card shadow-sm animate-on-scroll animate-slide-up" style="transition-delay: 0.3s;">
                <div class="card-header bg-light text-dark fw-bold"><i class="fas fa-bolt me-2"></i> Quick Actions</div>
                <div class="list-group list-group-flush action-list">
                    <a href="/new-invoice?patient_id=<%= patient.id %>" class="list-group-item list-group-item-action">
                        <i class="fas fa-file-invoice-dollar me-2 text-primary"></i> Generate New Invoice
                    </a>
                    <a href="/add-vitals?patient_id=<%= patient.id %>" class="list-group-item list-group-item-action">
                        <i class="fas fa-heartbeat me-2 text-danger"></i> Add Vitals Reading
                    </a>
                    <a href="/newrecord?patient_id=<%= patient.id %>" class="list-group-item list-group-item-action">
                        <i class="fas fa-notes-medical me-2 text-info"></i> Create Medical Record
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <h4 class="mb-3 text-dark animate-on-scroll animate-slide-up">Upcoming Appointments</h4>
            <div class="table-responsive shadow-sm mb-4 animate-on-scroll animate-slide-up" style="transition-delay: 0.1s;">
                <table class="table table-striped table-hover mb-0">
                    <thead><tr><th>Doctor</th><th>Date</th><th>Time</th><th>Status</th></tr></thead>
                    <tbody>
                        <% if(appointments.length > 0) { %>
                            <% appointments.forEach(appt => { %>
                            <tr>
                                <td><%= appt.doctor_name %></td>
                                <td><%= new Date(appt.appointment_date).toLocaleDateString() %></td>
                                <td><%= new Date('1970-01-01T' + appt.appointment_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></td>
                                <td><span class="badge bg-<%= appt.status === 'Confirmed' ? 'success' : 'warning' %>"><%= appt.status %></span></td>
                            </tr>
                            <% }); %>
                        <% } else { %>
                            <tr><td colspan="4" class="text-center">No upcoming appointments.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <h4 class="mb-3 text-dark animate-on-scroll animate-slide-up">Recent Medical Records</h4>
            <div class="table-responsive shadow-sm mb-4 animate-on-scroll animate-slide-up" style="transition-delay: 0.2s;">
                <table class="table table-striped table-hover mb-0">
                    <thead><tr><th>Date</th><th>Diagnosis</th><th>Action</th></tr></thead>
                    <tbody>
                        <% if(records.length > 0) { %>
                            <% records.forEach(rec => { %>
                            <tr>
                                <td><%= new Date(rec.record_date).toLocaleDateString() %></td>
                                <td><%= rec.diagnosis %></td>
                                <td><a href="/doctor/record/<%= rec.record_id %>" class="btn btn-sm btn-outline-primary">View</a></td>
                            </tr>
                            <% }); %>
                        <% } else { %>
                            <tr><td colspan="3" class="text-center">No medical records found.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <h4 class="mb-3 text-dark animate-on-scroll animate-slide-up">Recent Transactions</h4>
            <div class="table-responsive shadow-sm animate-on-scroll animate-slide-up" style="transition-delay: 0.3s;">
                <table class="table table-striped table-hover mb-0">
                    <thead><tr><th>Date</th><th>Type</th><th>Description</th><th class="text-end">Amount</th></tr></thead>
                    <tbody>
                        <% if(transactions.length > 0) { %>
                            <% transactions.forEach(t => { %>
                            <tr>
                                <td><%= new Date(t.created_at).toLocaleDateString() %></td>
                                <td><span class="badge bg-<%= t.amount > 0 ? 'success' : 'secondary' %>"><%= t.transaction_type %></span></td>
                                <td><%= t.description %></td>
                                <td class="text-end fw-bold <%= t.amount > 0 ? 'text-success' : 'text-danger' %>">
                                    <%= t.amount > 0 ? '+' : '' %>$<%= parseFloat(t.amount).toFixed(2) %>
                                </td>
                            </tr>
                            <% }); %>
                        <% } else { %>
                            <tr><td colspan="4" class="text-center">No wallet transactions.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<%- include('initials/footer.ejs') %>
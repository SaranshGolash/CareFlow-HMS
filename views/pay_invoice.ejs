<%- include('initials/header.ejs', { title: 'Process Payment' }) %>
<link rel="stylesheet" href="/styles/pay_invoice.css">
<script src="https://js.stripe.com/v3/"></script>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-md invoice-detail-card">
                    
                    <% const outstanding = (invoice.total_amount - invoice.amount_paid).toFixed(2); %>
                    
                    <div class="card-footer bg-light p-4">
                        <% if (outstanding > 0) { %>
                            <h5 class="mb-3 text-primary">Select Payment Method (Live Demo via Stripe)</h5>
                            
                            <div class="row g-3">
                                
                                <div class="col-md-4">
                                    <div class="nav flex-column nav-pills me-3 payment-tabs" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                        <button class="nav-link active" id="v-pills-card-tab" data-bs-toggle="pill" data-bs-target="#v-pills-card" type="button" role="tab" aria-controls="v-pills-card" aria-selected="true">
                                            <i class="fas fa-credit-card me-2"></i> Card (Stripe)
                                        </button>
                                        <button class="nav-link" id="v-pills-upi-tab" data-bs-toggle="pill" data-bs-target="#v-pills-upi" type="button" role="tab" aria-controls="v-pills-upi" aria-selected="false">
                                            <i class="fas fa-qrcode me-2"></i> UPI / QR Code (Mock)
                                        </button>
                                        <button class="nav-link" id="v-pills-netbanking-tab" data-bs-toggle="pill" data-bs-target="#v-pills-netbanking" type="button" role="tab" aria-controls="v-pills-netbanking" aria-selected="false">
                                            <i class="fas fa-bank me-2"></i> Net Banking (Mock)
                                        </button>
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <div class="tab-content" id="v-pills-tabContent">
                                        
                                        <div class="tab-pane fade show active" id="v-pills-card" role="tabpanel" aria-labelledby="v-pills-card-tab">
                                            <h6 class="text-muted mb-3">Secure Payment powered by Stripe Checkout.</h6>
                                            <form id="payment-form" class="row g-3">
                                                <input type="hidden" id="invoice_id_card" value="<%= invoice.invoice_id %>">
                                                <input type="hidden" id="outstanding_balance_card" value="<%= outstanding %>">

                                                <div class="col-12">
                                                    <label for="payment_amount_card" class="form-label">Amount to Pay ($)</label>
                                                    <input type="number" id="payment_amount_card_input" name="payment_amount_card" class="form-control" 
                                                           value="<%= outstanding %>" min="0.01" max="<%= outstanding %>" step="0.01" required>
                                                    <div class="form-text">Max due: $<%= outstanding %></div>
                                                </div>
                                                
                                                <div class="col-12 mt-4">
                                                    <button type="submit" id="checkout-button" class="btn btn-primary btn-lg w-100">
                                                        <i class="fas fa-credit-card me-2"></i> Pay Now via Stripe
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                        <div class="tab-pane fade" id="v-pills-upi" role="tabpanel" aria-labelledby="v-pills-upi-tab">
                                            <h6 class="text-muted mb-3">Scan to Pay using your preferred UPI app.</h6>
                                            <div class="text-center p-3 bg-white border rounded">
                                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=MockPaymentID_<%= invoice.invoice_id %>" alt="QR Code" class="img-fluid mb-3">
                                                <p class="small text-muted">UPI ID: careflow@bank</p>
                                            </div>
                                            <form action="/pay-invoice" method="POST" class="mt-3">
                                                <input type="hidden" name="invoice_id" value="<%= invoice.invoice_id %>">
                                                <input type="hidden" name="outstanding_balance" value="<%= outstanding %>">
                                                <input type="hidden" name="payment_amount" value="<%= outstanding %>">
                                                <button type="submit" class="btn btn-success w-100">
                                                    <i class="fas fa-check me-2"></i> Confirm UPI Payment (Mock Success)
                                                </button>
                                            </form>
                                        </div>

                                        <div class="tab-pane fade" id="v-pills-netbanking" role="tabpanel" aria-labelledby="v-pills-netbanking-tab">
                                            <div class="alert alert-warning mb-0">
                                                <i class="fas fa-bank me-2"></i> Net Banking is currently undergoing maintenance. Please use the Card or UPI option.
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        <% } else { %>
                            <div class="alert alert-success text-center mb-0">
                                <i class="fas fa-check-circle me-2"></i> This invoice is fully paid. Thank you!
                            </div>
                        <% } %>
                    </div>
                </div>
                
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // NOTE: Replace YOUR_STRIPE_PUBLIC_KEY with your actual Test/Live Publishable Key
            const stripe = Stripe('YOUR_STRIPE_PUBLIC_KEY'); 
            const checkoutButton = document.getElementById('checkout-button');
            const paymentForm = document.getElementById('payment-form');

            if (paymentForm) {
                paymentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const invoiceId = document.getElementById('invoice_id_card').value;
                    const amountInput = document.getElementById('payment_amount_card_input').value;
                    
                    if (!amountInput || parseFloat(amountInput) <= 0) {
                        alert('Please enter a valid amount.');
                        return;
                    }

                    // 1. Call your backend route to create the Stripe Session ID
                    const response = await fetch(`/create-checkout-session/${invoiceId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ amount_to_pay: amountInput }),
                    });
                    
                    const session = await response.json();

                    if (session.error) {
                        alert(`Payment initiation failed: ${session.error}`);
                    } else if (session.id) {
                        // 2. Redirect to Stripe Checkout
                        const result = await stripe.redirectToCheckout({
                            sessionId: session.id,
                        });

                        if (result.error) {
                            alert(result.error.message);
                        }
                    }
                });
            }
        });
    </script>
    <%- include('initials/footer.ejs') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
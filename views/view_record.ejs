<%- include('initials/header.ejs', { title: 'CareFlow - Record Detail' }) %>
<link rel="stylesheet" href="/styles/view_record.css">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <h2 class="mb-4 text-primary"><i class="fas fa-file-medical me-3"></i> Medical Record #<%= record.record_id %></h2>
                
                <div class="card shadow-md border-0">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Record Date: <%= new Date(record.record_date).toLocaleDateString() %></span>
                        <span class="small">Patient name: <%= record.username %></span>
                        <span class="small">Doctor name: <%= record.doctor_name %></span>
                    </div>
                    
                    <div class="card-body p-4">
                        
                        <!-- Diagnosis Section -->
                        <h4 class="text-dark mb-3"><i class="fas fa-user-md me-2 text-primary"></i> Primary Diagnosis</h4>
                        <div class="p-3 mb-4 bg-light rounded-3 detail-box">
                            <p class="mb-0 fs-5 fw-bold text-dark"><%= record.diagnosis %></p>
                        </div>

                        <!-- Vitals and Key Metrics -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h4 class="text-dark">Patient Information</h4>
                                <p class="text-secondary mb-1"><strong>Name:</strong> <%= record.username %></p>
                                <!-- Add more patient details if needed -->
                            </div>
        
                            <!-- NEW: Consulting Physician Section -->
                            <div class="col-md-6">
                                <h4 class="text-dark">Consulting Physician</h4>
                                <p class="text-secondary mb-1">
                                    <strong>Doctor:</strong> 
                                    <%= record.doctor_name || 'N/A (Unlinked Appointment)' %>
                                </p>
                            </div>
                            <hr>

                            <!-- Diagnosis Section -->
                            <h4 class="text-dark mb-3 mt-4"><i class="fas fa-file-waveform me-2 text-primary"></i> Diagnosis</h4>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-muted">Blood Pressure (mmHg):</label>
                                <p class="detail-value text-info"><%= record.blood_pressure || 'Not Recorded' %></p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-muted">Allergies:</label>
                                <p class="detail-value text-danger"><%= record.allergies || 'None Known' %></p>
                            </div>
                        </div>

                        <!-- Treatment Plan -->
                        <h4 class="text-dark mb-3 mt-4"><i class="fas fa-syringe me-2 text-primary"></i> Treatment Plan</h4>
                        <div class="p-3 mb-4 bg-light rounded-3 detail-box">
                            <p class="text-secondary"><%= record.treatment_plan || 'No formalized treatment plan recorded.' %></p>
                        </div>
                        
                        <!-- Doctor Notes -->
                        <h4 class="text-dark mb-3 mt-4"><i class="fas fa-notes-medical me-2 text-primary"></i> Doctor Notes</h4>
                        <div class="p-3 bg-light rounded-3 detail-box">
                            <p class="text-secondary"><%= record.doctor_notes || 'No detailed doctor notes provided for this visit.' %></p>
                        </div>
                        
                        <% if (user && (user.role === 'admin' || user.role === 'doctor')) { %>
                            <div class="mt-4 text-end">
                                <a href="/prescribe/<%= record.record_id %>" class="btn btn-primary">
                                    <i class="fas fa-file-prescription me-2"></i> Issue E-Prescription
                                </a>
                            </div>
                        <% } %>

                    </div>
                    
                    <div class="card-footer text-end bg-white">
                         <% 
                            // Determine the correct "Back" URL based on the user's role
                            let backUrl = "/records"; // Default URL for patients
                            if (user.role === 'doctor' || user.role === 'admin') {
                                // FIX: Use the 'record' object to get the user_id for the URL
                                backUrl = `/doctor/patient/${record.user_id}/records`;
                            }
                        %>

                        <a href="<%= backUrl %>" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Back to Records List
                        </a>
                    </div>
            </div>
        </div>
    </div>
<%- include('initials/footer.ejs') %>

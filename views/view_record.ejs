<%- include('initials/header.ejs', { title: 'CareFlow - Record Detail' }) %>
<link rel="stylesheet" href="/styles/view_record.css">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <h2 class="mb-4 text-primary"><i class="fas fa-file-medical me-3"></i> Medical Record #<%= record.record_id %></h2>
                
                <div class="card shadow-md border-0">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Record Date: <%= new Date(record.record_date).toLocaleDateString() %></span>
                        <span class="small">Patient name: <%= record.username %></span>
                        <span class="small">Doctor name: <%= record.doctor_name %></span>
                    </div>
                    
                    <div class="card-body p-4">
                        
                        <!-- Diagnosis Section -->
                        <h4 class="text-dark mb-3"><i class="fas fa-user-md me-2 text-primary"></i> Primary Diagnosis</h4>
                        <div class="p-3 mb-4 bg-light rounded-3 detail-box">
                            <p class="mb-0 fs-5 fw-bold text-dark"><%= record.diagnosis %></p>
                        </div>

                        <!-- Vitals and Key Metrics -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h4 class="text-dark">Patient Information</h4>
                                <p class="text-secondary mb-1"><strong>Name:</strong> <%= record.username %></p>
                                <!-- Add more patient details if needed -->
                            </div>
        
                            <!-- NEW: Consulting Physician Section -->
                            <div class="col-md-6">
                                <h4 class="text-dark">Consulting Physician</h4>
                                <p class="text-secondary mb-1">
                                    <strong>Doctor:</strong> 
                                    <%= record.doctor_name || 'N/A (Unlinked Appointment)' %>
                                </p>
                            </div>
                            <hr>

                            <!-- Diagnosis Section -->
                            <h4 class="text-dark mb-3 mt-4"><i class="fas fa-file-waveform me-2 text-primary"></i> Diagnosis</h4>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-muted">Blood Pressure (mmHg):</label>
                                <p class="detail-value text-info"><%= record.blood_pressure || 'Not Recorded' %></p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-muted">Allergies:</label>
                                <p class="detail-value text-danger"><%= record.allergies || 'None Known' %></p>
                            </div>
                        </div>

                        <!-- Treatment Plan -->
                        <h4 class="text-dark mb-3 mt-4"><i class="fas fa-syringe me-2 text-primary"></i> Treatment Plan</h4>
                        <div class="p-3 mb-4 bg-light rounded-3 detail-box">
                            <p class="text-secondary"><%= record.treatment_plan || 'No formalized treatment plan recorded.' %></p>
                        </div>
                        
                        <!-- Doctor Notes -->
                        <h4 class="text-dark mb-3 mt-4"><i class="fas fa-notes-medical me-2 text-primary"></i> Doctor Notes</h4>
                        <div class="p-3 bg-light rounded-3 detail-box">
                            <p class="text-secondary"><%= record.doctor_notes || 'No detailed doctor notes provided for this visit.' %></p>
                        </div>
                        
                        <% if (user && (user.role === 'admin' || user.role === 'doctor')) { %>
                            <div class="mt-4 text-end">
                                <a href="/prescribe/<%= record.record_id %>" class="btn btn-primary">
                                    <i class="fas fa-file-prescription me-2"></i> Issue E-Prescription
                                </a>
                            </div>
                        <% } %>

                        <div class="mt-5">
    <hr>
    <h4 class="text-dark mb-3 mt-4"><i class="fas fa-vial me-2 text-primary"></i> Attached Files</h4>
    
    <% if (patientFiles && patientFiles.length > 0) { %>
        <ul class="list-group mb-3">
            <% patientFiles.forEach(file => { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-file-alt me-2 text-muted"></i>
                        <a href="<%= file.file_path %>" target="_blank"><%= file.original_name %></a>
                        <span class="badge bg-secondary ms-2"><%= file.file_type %></span>
                    </div>
                    <small class="text-muted"><%= new Date(file.uploaded_at).toLocaleDateString() %></small>
                </li>
            <% }); %>
        </ul>
    <% } else { %>
        <p class="text-muted">No files are attached to this record.</p>
    <% } %>

    <% if (user && (user.role === 'admin' || user.role === 'doctor')) { %>
        <hr>
        <h5 class="mt-4">Attach New File</h5>
        <form action="/doctor/upload-lab" method="POST" enctype="multipart/form-data" class="row g-3">
            <input type="hidden" name="record_id" value="<%= record.record_id %>">
            <input type="hidden" name="user_id" value="<%= record.user_id %>">
            
            <div class="col-md-5">
                <label for="file_type" class="form-label">File Type</label>
                <select id="file_type" name="file_type" class="form-select form-control" style="height: 48px;">
                    <option value="Lab Result" selected>Lab Result</option>
                    <option value="X-Ray">X-Ray</option>
                    <option value="Referral">Referral</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="col-md-7">
                <label for="labResult" class="form-label">Select File (PDF, PNG, JPG)</label>
                <input type="file" class="form-control" id="labResult" name="labResult" accept=".pdf,.png,.jpg,.jpeg" required>
            </div>
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i> Attach File
                </button>
            </div>
        </form>
    <% } %>
</div>
                    </div>
                    
                    <div class="card-footer text-end bg-white">
                        <% 
                            let backUrl = "/records"; // Default for patients
                            // If the logged-in user is a doctor/admin, generate the correct back link
                            if (user && (user.role === 'doctor' || user.role === 'admin')) {
                                backUrl = `/doctor/patient/${record.user_id}/records`;
                            }
                        %>
                        <a href="<%= backUrl %>" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Back to Records List
                        </a>
                    </div>
            </div>
        </div>
    </div>
<%- include('initials/footer.ejs') %>
